<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="/src/msk/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/src/msk/favicon.svg" />
  <link rel="shortcut icon" href="/src/msk/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/src/msk/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="MSK Tool" />
  <link rel="manifest" href="/src/msk/site.webmanifest" />
  <style>
    :root {
      --blue-color: rgb(30,113,173);
      --blue-accent: rgb(39,183,205);
      --faint-blue-color: rgb(230,240,247);
      --text: #1f2937;
      --card: #ffffff;
      --muted: #8da3b8;
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow: 0 4px 16px rgba(0,0,0,0.08);
      --radius: 14px;
    }

    html, body {
      margin: 0; height: 100%; font-family: Facit, Calibri, Helvetica, Arial, sans-serif;
      color: var(--text); background: #f7fbff;
    }

    #title {
      display: flex; justify-content: center; align-items: center; text-align: center;
      padding: 0.75rem 1rem; color: #fff; font-weight: 700; letter-spacing: 0.2px;
      background: linear-gradient(318deg, var(--blue-color) 0%, var(--blue-accent) 100%);
      position: sticky; top: 0; z-index: 5;
    }

    .layout { display: grid; grid-template-columns: 280px 1fr 360px; gap: 0.75rem; padding: 0.75rem; height: calc(100vh - 56px); box-sizing: border-box; }

    .panel { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; min-height: 0; }

    .panel h3 { margin: 0; padding: 0.9rem 1rem; color: var(--blue-color); border-bottom: 1px solid #eaf1f7; }

    .panel .content { padding: 0.75rem 1rem; overflow: auto; }

    /* Left panel: Region picker */
    .regions { display: grid; grid-template-columns: 1fr; gap: 0.5rem; }
    .chip { appearance: none; border: 1px solid #e3eef7; background: #fff; border-radius: 999px; padding: 0.5rem 0.75rem; cursor: pointer; transition: .15s ease; display: flex; align-items: center; justify-content: space-between; }
    .chip:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .chip.selected { background: var(--faint-blue-color); border-color: var(--blue-color); }
    .chip small { color: var(--muted); }

    /* Middle panel: Flow */
    .step { border-left: 3px solid #e5eff7; padding-left: 0.75rem; margin-left: 0.25rem; position: relative; }
    .step::before { content: ""; position: absolute; left: -7px; top: 6px; width: 10px; height: 10px; background: #dbe9f6; border-radius: 50%; }
    .step.active::before { background: var(--blue-accent); }
    .q { font-weight: 600; margin: 0.25rem 0 0.5rem; }
    .btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn { border: none; border-radius: 10px; padding: 0.5rem 0.65rem; cursor: pointer; background: #eef6fd; color: var(--blue-color); font-weight: 600; }
    .btn:hover { filter: brightness(0.97); }
    .btn[data-val="pos"] { background: #ecfdf3; color: #166534; }
    .btn[data-val="neg"] { background: #fef3c7; color: #92400e; }
    .btn[data-val="na"] { background: #f3f4f6; color: #374151; }
    .btn.selected { outline: 2px solid currentColor; }

    .explain { margin-top: 0.35rem; color: #4b5563; font-size: 0.9rem; }
    details summary { cursor: pointer; color: var(--blue-color); }

    .controls { margin-top: auto; display: flex; gap: 0.5rem; padding-top: 0.75rem; border-top: 1px solid #eaf1f7; }
    .control { flex: 1; background: var(--blue-color); color: #fff; border: none; padding: 0.6rem; border-radius: 10px; font-weight: 700; cursor: pointer; }
    .control.secondary { background: #e5eff7; color: var(--blue-color); }

    /* Right panel: Diagnoses */
    .dx-list { display: grid; gap: 0.5rem; }
    .dx { border: 1px solid #eaf1f7; border-radius: 12px; padding: 0.6rem 0.75rem; }
    .dx h4 { margin: 0 0 0.25rem; font-size: 1rem; color: #0f172a; }
    .meter { height: 8px; background: #eef2f7; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--blue-color), var(--blue-accent)); transition: width .25s ease; }
    .tag { display: inline-block; padding: 0.15rem 0.45rem; border-radius: 999px; font-size: 0.75rem; background: #f1f5f9; color: #475569; margin-right: 0.3rem; }

    .disclaimer { margin-top: 0.75rem; font-size: 0.85rem; color: #6b7280; }

    @media (max-width: 1024px) {
      .layout { grid-template-columns: 1fr; height: auto; }
      .panel { min-height: 40vh; }
    }
  </style>
</head>
<body>
  <div id="title">MSK Flowchart Tool</div>
  <div class="layout">
    <!-- LEFT: Region selector -->
    <section class="panel" aria-label="Region selector">
      <h3>1) Choose area</h3>
      <div class="content">
        <div class="regions" id="regionList"></div>
      </div>
    </section>

    <!-- MIDDLE: Flow steps -->
    <section class="panel" aria-label="Assessment flow">
      <h3>2) Work through tests</h3>
      <div class="content" id="steps"></div>
      <div class="content controls">
        <button class="control secondary" id="resetBtn">Reset</button>
        <button class="control" id="exportBtn">Export summary</button>
      </div>
    </section>

    <!-- RIGHT: Diagnoses ranking -->
    <section class="panel" aria-label="Suggested diagnoses">
      <h3>3) Possible diagnoses</h3>
      <div class="content">
        <div id="dxList" class="dx-list"></div>
        <div class="disclaimer">
          This tool is for educational use and decision support. It does not replace clinical judgement, red-flag screening, or imaging where indicated.
        </div>
      </div>
    </section>
  </div>

  <script>
    // --- Data model ---------------------------------------------------------
    // Each region has: tests[] where each test has id, label, info, and effects[]
    // An effect is: { when: 'pos'|'neg', dx: 'Diagnosis', weight: number }

    const DATA = {
      Shoulder: {
        tests: [
          { id: 'painfulArc', label: 'Painful arc (60°–120° abduction)', info: 'Patient actively abducts in scapular plane; pain between ~60–120° that eases past 120° suggests subacromial involvement. <a href="https://www.physio-pedia.com/Painful_Arc" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Subacromial pain (nonspecific)', weight: 2 },
            { when: 'pos', dx: 'Rotator cuff tendinopathy', weight: 2 }
          ]},
          { id: 'resistedAbd', label: 'Resisted abduction (Jobe/Empty Can)', info: 'Abduct 90° in scapular plane, internally rotate (thumb down); resist downward pressure—pain/weakness implicates supraspinatus. <a href="https://www.physio-pedia.com/Empty_Can_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Rotator cuff tear (supraspinatus)', weight: 3 },
            { when: 'pos', dx: 'Rotator cuff tendinopathy', weight: 2 }
          ]},
          { id: 'hawkins', label: 'Hawkins–Kennedy', info: 'Flex shoulder/elbow 90°; forcibly internally rotate shoulder—pain indicates subacromial pain. <a href="https://www.physio-pedia.com/Hawkins_/_Kennedy_Impingement_Test_of_the_Shoulder" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Subacromial pain (nonspecific)', weight: 2 }
          ]},
          { id: 'neer', label: 'Neer sign', info: 'Stabilise scapula; passively flex internally rotated arm fully overhead—pain suggests subacromial involvement. <a href="https://www.physio-pedia.com/Neer_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Subacromial pain (nonspecific)', weight: 2 }
          ]},
          { id: 'erResisted', label: 'Resisted external rotation', info: 'Elbow 90° at side; resist patient’s ER (you push into IR). Weakness/pain → infraspinatus/teres minor. <a href="https://www.physio-pedia.com/Infraspinatus_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Rotator cuff tear (infraspinatus)', weight: 3 },
            { when: 'pos', dx: 'Rotator cuff tendinopathy', weight: 1 }
          ]},
          { id: 'dropArm', label: 'Drop-arm', info: 'Passively abduct to 90°; ask patient to slowly lower—uncontrolled drop/pain suggests full-thickness tear. <a href="https://www.physio-pedia.com/Drop_Arm_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Full-thickness rotator cuff tear', weight: 5 }
          ]},
          { id: 'acCross', label: 'Scarf Test', info: 'Flex shoulder 90°; horizontally adduct across chest—focal ACJ pain suggests AC pathology. <a href="https://www.physio-pedia.com/Scarf_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'AC joint pathology', weight: 3 }
          ]},
          { id: 'capsularPattern', label: 'Capsular pattern (ER > Abd > IR loss)', info: 'Assess A/PROM; greatest loss ER, then abduction, then IR with firm capsular end-feel → adhesive capsulitis. <a href="https://www.physio-pedia.com/Adhesive_Capsulitis" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Adhesive capsulitis (frozen shoulder)', weight: 4 }
          ]}
        ]
      },

      Elbow: {
        tests: [
          { id: 'cozen', label: "Cozen's (resisted wrist extension)", info: 'Elbow ≈90° flexed; make fist, extend wrist against resistance—pain at lateral epicondyle. <a href="https://www.physio-pedia.com/Cozen’s_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lateral epicondylalgia (tennis elbow)', weight: 3 }
          ]},
          { id: 'mills', label: "Mill's (passive wrist flexion)", info: 'Elbow extended, forearm pronated; passively flex wrist—stretch pain at lateral epicondyle. <a href="https://www.physio-pedia.com/Mill’s_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lateral epicondylalgia (tennis elbow)', weight: 2 }
          ]},
          { id: 'chair', label: 'Chair/Grip provocation', info: 'Lift a chair or grip strongly with elbow extended—lateral epicondyle pain is supportive. <a href="https://www.physio-pedia.com/Chair_Lift_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lateral epicondylalgia (tennis elbow)', weight: 2 }
          ]},
          { id: 'golfers', label: "Medial epicondylalgia (Golfer's)", info: 'Resist wrist flexion/pronation or passively extend wrist/supinate—medial epicondyle pain. <a href="https://www.physio-pedia.com/Golfer’s_Elbow_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: "Medial epicondylalgia (golfer's elbow)", weight: 4 }
          ]},
          { id: 'tinelUlnar', label: 'Tinel at cubital tunnel', info: 'Tap between medial epicondyle and olecranon—paresthesia in ulnar distribution. <a href="https://www.physio-pedia.com/Cubital_Tunnel_Syndrome" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Ulnar neuropathy at elbow', weight: 2 }
          ]}
        ]
      },

      WristHand: {
        tests: [
          { id: 'phalen', label: "Phalen's / Reverse Phalen's", info: 'Flex wrists maximally for ~60s or press dorsum-to-dorsum—reproduce median-nerve paresthesia. <a href="https://www.physio-pedia.com/Phalen’s_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Carpal tunnel syndrome', weight: 3 }
          ]},
          { id: 'durkan', label: 'Durkan (carpal compression)', info: 'Thumbs apply direct pressure over carpal tunnel for ~30s—paresthesia in median distribution. <a href="https://www.physio-pedia.com/Carpal_Compression_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Carpal tunnel syndrome', weight: 3 }
          ]},
          { id: 'tinelWrist', label: 'Tinel at carpal tunnel', info: 'Percuss volar wrist over median nerve—tingling in median distribution. <a href="https://www.physio-pedia.com/Tinel’s_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Carpal tunnel syndrome', weight: 2 }
          ]},
          { id: 'finkelstein', label: "Finkelstein's", info: 'Thumb in fist; ulnar-deviate wrist—pain over 1st dorsal compartment. <a href="https://www.physio-pedia.com/Finkelstein_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: "De Quervain's tenosynovitis", weight: 4 }
          ]},
          { id: 'snuffbox', label: 'Scaphoid snuffbox tenderness', info: 'Palpate snuffbox after trauma—tenderness raises suspicion; absence lowers it. <a href="https://www.physio-pedia.com/Scaphoid_Fracture" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Scaphoid fracture (consider imaging)', weight: 3 },
            { when: 'neg', dx: 'Scaphoid fracture (consider imaging)', weight: -2 }
          ]},
          { id: 'tfccGrind', label: 'TFCC load / ulnar grind', info: 'Ulnar-deviate wrist, apply axial load with pronation/supination—ulnar-sided pain/click. <a href="https://www.physio-pedia.com/Triangular_Fibrocartilage_Complex_(TFCC)_Injury" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'TFCC injury', weight: 3 }
          ]},
          { id: 'fovea', label: 'Ulnar fovea sign', info: 'Press between ulnar styloid and FCU tendon—point tenderness suggests TFCC/ulnar capsular injury. <a href="https://www.physio-pedia.com/Fovea_Sign" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'TFCC injury', weight: 3 }
          ]}
        ]
      },

      Neck: {
        tests: [
          { id: 'spurling', label: "Spurling's", info: 'Extend, side-bend toward symptoms; apply axial compression—reproduce arm pain/paresthesia. <a href="https://www.physio-pedia.com/Spurling%27s_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Cervical radiculopathy', weight: 3 },
            { when: 'neg', dx: 'Cervical radiculopathy', weight: -1 }
          ]},
          { id: 'distraction', label: 'Cervical distraction relief', info: 'Supine/sitting; apply gentle traction—symptom relief supports radiculopathy. <a href="https://www.physio-pedia.com/Cervical_Distraction_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Cervical radiculopathy', weight: 3 },
            { when: 'neg', dx: 'Cervical radiculopathy', weight: -1 }
          ]},
          { id: 'ulntt', label: 'ULNTT (median bias)', info: 'Shoulder dep/ABD, wrist/finger ext, supination, ER, elbow ext—reproduce symptoms. <a href="https://www.physio-pedia.com/Upper_Limb_Tension_Tests_(ULTTs)" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Cervical radiculopathy', weight: 2 },
            { when: 'neg', dx: 'Cervical radiculopathy', weight: -1 }
          ]},
          { id: 'cervRot', label: 'Cervical rotation < 60°', info: 'Measure active rotation toward symptomatic side; <60° adds to Wainner cluster. <a href="https://www.physio-pedia.com/Wainner_Cluster" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Cervical radiculopathy', weight: 2 }
          ]},
          { id: 'mechNeck', label: 'Mechanical neck pain pattern', info: 'Local neck pain without neurotension; movement-provoked, non-radicular. <a href="https://www.physio-pedia.com/Mechanical_Neck_Pain" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Mechanical neck pain', weight: 2 }
          ]}
        ]
      },

      LowBack: {
        tests: [
          { id: 'slr', label: 'Straight leg raise (SLR)', info: 'Supine; passively raise straight leg—radicular pain 30–70° suggests root irritation. <a href="https://www.physio-pedia.com/Straight_Leg_Raise_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lumbar radiculopathy (L5/S1)', weight: 3 },
            { when: 'neg', dx: 'Lumbar radiculopathy (L5/S1)', weight: -1 }
          ]},
          { id: 'slump', label: 'Slump test', info: 'Seated; slump, cervical flex, knee ext, ankle DF—symptom reproduction indicates neural tension. <a href="https://www.physio-pedia.com/Slump_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lumbar radiculopathy', weight: 3 },
            { when: 'neg', dx: 'Lumbar radiculopathy', weight: -1 }
          ]},
          { id: 'stenosis', label: 'Neurogenic claudication pattern', info: 'Worse with walking/extension, relieved by sitting/flexion. <a href="https://www.physio-pedia.com/Lumbar_Spinal_Stenosis" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lumbar spinal stenosis', weight: 4 }
          ]},
          { id: 'flexionWorse', label: 'Symptoms worse in flexion', info: 'Flexion increases symptoms—argues against classic stenosis pattern. <a href="https://www.physio-pedia.com/Lumbar_Spinal_Stenosis" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lumbar spinal stenosis', weight: -2 }
          ]}
        ]
      },

      Hip: {
        tests: [
          { id: 'fadir', label: 'FADIR (impingement test)', info: 'Supine; flex hip 90°, adduct, internally rotate—anterior/groin pain suggests intra-articular pathology. <a href="https://www.physio-pedia.com/FADIR_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'FAI / labral pathology', weight: 2 }
          ]},
          { id: 'faber', label: 'FABER/Patrick', info: 'Figure-4; press down on knee/ASIS—anterior pain hip joint; posterior pain → SIJ. <a href="https://www.physio-pedia.com/FABER_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Hip OA / intra-articular pathology', weight: 2 },
            { when: 'pos', dx: 'SI joint involvement', weight: 1 }
          ]},
          { id: 'trendelenburg', label: 'Trendelenburg sign', info: 'Single-leg stance; pelvic drop on opposite side suggests abductor weakness. <a href="https://www.physio-pedia.com/Trendelenburg_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Greater trochanteric pain syndrome', weight: 2 }
          ]},
          { id: 'logroll', label: 'Log roll', info: 'Supine; passively roll leg into ER/IR—pain/click = intra-articular pathology. <a href="https://www.physio-pedia.com/The_Log_Roll_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Hip OA / intra-articular pathology', weight: 2 }
          ]}
        ]
      },

      Knee: {
        tests: [
          { id: 'lachman', label: 'Lachman', info: 'Knee 20–30°; stabilise femur, translate tibia anteriorly—excess translation/soft end-point. <a href="https://www.physio-pedia.com/Lachman_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'ACL injury', weight: 5 }
          ]},
          { id: 'pivotShift', label: 'Pivot shift', info: 'Extended knee slight valgus/IR; flex—clunk indicates ACL deficiency. <a href="https://www.physio-pedia.com/Pivot_Shift" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'ACL injury', weight: 5 }
          ]},
          { id: 'antDrawer', label: 'Anterior drawer', info: 'Hip 45°, knee 90°; pull tibia anteriorly—excess translation. <a href="https://www.physio-pedia.com/Anterior_Drawer_Test_of_the_Knee" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'ACL injury', weight: 2 }
          ]},
          { id: 'valgus', label: 'Valgus stress at 30°', info: 'At 30° flexion, apply valgus—medial opening/pain = MCL injury. <a href="https://www.physio-pedia.com/Valgus_Stress_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'MCL injury', weight: 4 }
          ]},
          { id: 'varus', label: 'Varus stress at 30°', info: 'At 30° flexion, apply varus—lateral opening/pain = LCL injury. <a href="https://www.physio-pedia.com/Lateral_Collateral_Ligament_Injury_of_the_Knee" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'LCL injury', weight: 4 }
          ]},
          { id: 'mcmurray', label: "McMurray's", info: 'Flex knee; rotate tibia with valgus/varus while extending—joint-line pain/click. <a href="https://www.physio-pedia.com/McMurrays_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Meniscal tear', weight: 2 },
            { when: 'neg', dx: 'Meniscal tear', weight: -1 }
          ]},
          { id: 'thessaly', label: 'Thessaly (5°/20°)', info: 'Stand on one leg; flex 5°/20°, rotate—joint-line pain/catching. <a href="https://www.physio-pedia.com/Thessaly_test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Meniscal tear', weight: 2 },
            { when: 'neg', dx: 'Meniscal tear', weight: -1 }
          ]},
          { id: 'pfp', label: 'Patellofemoral pain pattern', info: 'Retropatellar pain with stairs/squats, sitting; crepitus without locking. <a href="https://www.physio-pedia.com/Patellofemoral_Pain_Syndrome" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Patellofemoral pain syndrome', weight: 4 }
          ]}
        ]
      },

      AnkleFoot: {
        tests: [
          { id: 'antDrawerAnkle', label: 'Anterior drawer (ankle)', info: 'Stabilise tibia; draw talus anteriorly (ankle ~10–20° PF)—excess laxity = ATFL injury. <a href="https://www.physio-pedia.com/Anterior_Drawer_of_the_Ankle" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lateral ankle sprain (ATFL)', weight: 4 }
          ]},
          { id: 'talarTilt', label: 'Talar tilt', info: 'Neutral/slight PF; invert talus—excess tilt/pain = CFL injury. <a href="https://www.physio-pedia.com/Talar_tilt" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lateral ankle sprain (CFL)', weight: 3 }
          ]},
          { id: 'latLigTender', label: 'ATFL/CFL ligament tenderness', info: 'Palpate ATFL (anterior to lat malleolus) and CFL (inferior/posterior)—tenderness supports sprain. <a href="https://www.physio-pedia.com/Lateral_Ligament_Injury_of_the_Ankle" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Lateral ankle sprain (ATFL)', weight: 2 },
            { when: 'pos', dx: 'Lateral ankle sprain (CFL)', weight: 2 }
          ]},
          { id: 'squeeze', label: 'Squeeze test', info: 'Compress tibia/fibula mid-calf; distal pain = syndesmosis injury. <a href="https://www.physio-pedia.com/Squeeze_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'High ankle sprain (syndesmosis)', weight: 3 }
          ]},
          { id: 'extRotation', label: 'External rotation stress', info: 'Stabilise leg; externally rotate foot—anterolateral pain indicates syndesmosis. <a href="https://www.physio-pedia.com/Foot_and_Ankle_Assessment-Investigations_and_Tests" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'High ankle sprain (syndesmosis)', weight: 3 }
          ]},
          { id: 'dfExtRotation', label: 'Dorsiflexion–external rotation', info: 'DF foot, apply external rotation—pain/reproduction = syndesmosis. <a href="https://www.physio-pedia.com/Foot_and_Ankle_Assessment-Investigations_and_Tests" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'High ankle sprain (syndesmosis)', weight: 3 }
          ]},
          { id: 'thompson', label: "Thompson's test", info: 'Prone/kneel; squeeze calf—absence of PF = Achilles rupture. <a href="https://www.physio-pedia.com/Thompson_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Achilles tendon rupture', weight: 5 }
          ]},
          { id: 'windlass', label: 'Windlass test', info: 'Extend great toe (WB/seated) to tension plantar fascia—heel pain reproduction = positive. <a href="https://www.physio-pedia.com/Windlass_Test" target="_blank" rel="noopener">Physiopedia</a>', effects: [
            { when: 'pos', dx: 'Plantar fasciitis', weight: 3 }
          ]}
        ]
      }
    };




    const REGION_META = {
      Shoulder: { note: 'Painful arc → subacromial; strength loss → cuff.' },
      Elbow: { note: 'Differentiate lateral/medial tendinopathy vs ulnar neuropathy.' },
      WristHand: { note: 'Median nerve vs 1st dorsal compartment vs TFCC/scaphoid.' },
      Neck: { note: 'Cluster tests for radiculopathy (Spurling + ULNTT + Distraction).' },
      LowBack: { note: 'Screen red flags; consider pattern recognition for stenosis.' },
      Hip: { note: 'Differentiate intra-articular, peri-trochanteric, or SIJ.' },
      Knee: { note: 'Ligament vs meniscus vs patellofemoral pattern.' },
      AnkleFoot: { note: 'ATFL/CFL vs syndesmosis; screen for Achilles rupture.' }
    };

    // --- State --------------------------------------------------------------
    let state = {
      region: null,
      answers: {}, // testId -> 'pos' | 'neg' | 'na'
    };

    // --- DOM helpers --------------------------------------------------------
    const regionList = document.getElementById('regionList');
    const stepsEl = document.getElementById('steps');
    const dxList = document.getElementById('dxList');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');

    function h(tag, attrs = {}, ...children) {
      const el = document.createElement(tag);
      for (const [k, v] of Object.entries(attrs)) {
        if (k === 'class') el.className = v;
        else if (k.startsWith('on') && typeof v === 'function') el.addEventListener(k.substring(2).toLowerCase(), v);
        else if (v !== null && v !== undefined) el.setAttribute(k, v);
      }
      for (const c of children) {
        if (c == null) continue;
        if (typeof c === 'string') el.appendChild(document.createTextNode(c));
        else el.appendChild(c);
      }
      return el;
    }

    // --- Rendering ----------------------------------------------------------
    function renderRegions() {
      regionList.innerHTML = '';
      Object.keys(DATA).forEach(key => {
        const meta = REGION_META[key] || {}; 
        const chip = h('button', { class: 'chip' + (state.region === key ? ' selected' : ''), onClick: () => selectRegion(key), 'aria-pressed': state.region === key },
          h('span', {}, key.replace(/([A-Z])/g, ' $1').trim()),
          h('small', {}, meta.note || '')
        );
        regionList.appendChild(chip);
      });
    }

    function selectRegion(key) {
      state.region = key;
      // initialise all tests for this region to 'Not tested'
      state.answers = {};
      const { tests } = DATA[state.region];
      tests.forEach(t => { state.answers[t.id] = 'na'; });
      renderRegions();
      renderSteps();
      renderDx();
    }

    function renderSteps() {
      stepsEl.innerHTML = '';
      if (!state.region) {
        stepsEl.appendChild(h('p', {}, 'Pick an area on the left to begin.'));
        return;
      }

      const { tests } = DATA[state.region];

      // Active step = first test still marked 'Not tested'
      let activeIdx = tests.findIndex(t => state.answers[t.id] === 'na');
      if (activeIdx === -1) activeIdx = tests.length - 1;

      tests.forEach((t, i) => {
        const step = h('div', { class: 'step' + (i === activeIdx ? ' active' : '') });
        step.appendChild(h('div', { class: 'q' }, `${i + 1}. ${t.label}`));

        // Buttons
        const btns = h('div', { class: 'btns' });
        ['pos', 'neg', 'na'].forEach(val => {
          const map = { pos: 'Positive', neg: 'Negative', na: 'Not tested' };
          const b = h(
            'button',
            {
              class: 'btn' + (state.answers[t.id] === val ? ' selected' : ''),
              'data-val': val,
              onClick: () => setAnswer(t.id, val),
              'aria-pressed': state.answers[t.id] === val ? 'true' : 'false'
            },
            map[val]
          );
          btns.appendChild(b);
        });
        step.appendChild(btns);

        // Info (allow HTML so <a> links render)
        const infoDetails = document.createElement('details');
        infoDetails.className = 'explain';

        const summary = document.createElement('summary');
        summary.textContent = 'How to perform / what it means';
        infoDetails.appendChild(summary);

        const infoDiv = document.createElement('div');
        infoDiv.innerHTML = t.info; // renders anchor tags as clickable links
        infoDetails.appendChild(infoDiv);

        step.appendChild(infoDetails);
        stepsEl.appendChild(step);
      });
    }



    function setAnswer(id, val) {
      state.answers[id] = val;
      renderSteps();
      renderDx();
    }

    function renderDx() {
      dxList.innerHTML = '';
      if (!state.region) return;
      const { tests } = DATA[state.region];

      // aggregate scores
      const scores = new Map();
      for (const t of tests) {
        const ans = state.answers[t.id];
        if (!ans) continue;
        for (const e of t.effects) {
          if (e.when === ans) {
            scores.set(e.dx, (scores.get(e.dx) || 0) + e.weight);
          }
        }
      }

      // create a baseline list from all possible dx in this region
      const allDx = new Set();
      tests.forEach(t => t.effects.forEach(e => allDx.add(e.dx)));
      const items = [...allDx].map(dx => ({ dx, score: scores.get(dx) || 0 }));

      // sort
      items.sort((a,b) => b.score - a.score);

      const max = Math.max(1, ...items.map(i => i.score));

      items.forEach(({dx, score}) => {
        const row = h('div', { class: 'dx' });
        row.appendChild(h('h4', {}, dx));
        const meter = h('div', { class: 'meter' }, h('div', { class: 'bar', style: `width: ${Math.round((score/max)*100)}%` }));
        row.appendChild(meter);
        const tags = h('div', {},
          h('span', { class: 'tag' }, 'Score: ' + score),
          (score === 0 ? h('span', { class: 'tag' }, 'No supporting tests yet') : null)
        );
        row.appendChild(tags);
        dxList.appendChild(row);
      });

      if (items.length === 0) {
        dxList.appendChild(h('p', {}, 'Complete some tests to see suggestions.'));
      }
    }

    // --- Export & Reset -----------------------------------------------------
    resetBtn.addEventListener('click', () => {
      if (!state.region) return;
      const { tests } = DATA[state.region];
      state.answers = {};
      tests.forEach(t => { state.answers[t.id] = 'na'; });
      renderSteps();
      renderDx();
    });

    exportBtn.addEventListener('click', () => {
      if (!state.region) { alert('Select an area first.'); return; }
      const lines = [];
      lines.push(`# MSK Flowchart Summary`);
      lines.push(`Region: ${state.region}`);
      lines.push('');

      const tests = DATA[state.region].tests;
      tests.forEach((t, i) => {
        const ans = state.answers[t.id] || '—';
        const map = { pos: 'Positive', neg: 'Negative', na: 'Not tested', '—': '—' };
        lines.push(`${i+1}. ${t.label}: ${map[ans]}`);
      });

      // top 5 diagnoses
      const scores = new Map();
      for (const t of tests) {
        const ans = state.answers[t.id];
        if (!ans) continue;
        for (const e of t.effects) {
          if (e.when === ans) scores.set(e.dx, (scores.get(e.dx) || 0) + e.weight);
        }
      }
      const ranking = [...scores.entries()].sort((a,b) => b[1]-a[1]).slice(0,5);
      lines.push('\nTop suggestions:');
      if (ranking.length === 0) lines.push('—');
      ranking.forEach(([dx, s]) => lines.push(`- ${dx} (score ${s})`));

      const blob = new Blob([lines.join('\n')], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `MSK_Flowchart_${state.region}.txt`; a.click();
      URL.revokeObjectURL(url);
    });

    // --- Init ---------------------------------------------------------------
    renderRegions();
  </script>
</body>
</html>
